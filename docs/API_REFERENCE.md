# API Reference

Complete reference for DotNetSample REST API endpoints.

## Overview

- **Base URL:** `http://localhost:5181`
- **Authentication:** None (development mode)
- **Content-Type:** `application/json`
- **Swagger UI:** `http://localhost:5181/swagger` (when running in Development mode)

All endpoints return JSON unless otherwise noted. Request bodies must use `application/json`.

---

## Customers API

### GET /api/customers

Returns all customers in the system.

**Response:** `200 OK`

```json
[
  {
    "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "name": "Alice Johnson",
    "email": "alice@example.com"
  },
  {
    "id": "7c9e6679-7425-40de-944b-e07fc1f90ae7",
    "name": "Bob Smith",
    "email": "bob@example.com"
  }
]
```

---

### GET /api/customers/paged

Returns a paginated list of customers.

**Query Parameters:**
- `pageNumber` (int, optional, default=1) — 1-based page number
- `pageSize` (int, optional, default=10) — Number of items per page

**Example:** `/api/customers/paged?pageNumber=2&pageSize=20`

**Response:** `200 OK`

```json
[
  {
    "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "name": "Alice Johnson",
    "email": "alice@example.com"
  }
]
```

---

### GET /api/customers/{id}

Gets a single customer by ID.

**Path Parameters:**
- `id` (guid, required) — Customer identifier

**Response:** `200 OK` or `404 Not Found`

```json
{
  "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "name": "Alice Johnson",
  "email": "alice@example.com"
}
```

---

### POST /api/customers

Creates a new customer.

**Request Body:**

```json
{
  "name": "Charlie Davis",
  "email": "charlie@example.com"
}
```

**Notes:**
- The `id` field is auto-generated by the server and should be omitted
- Both `name` and `email` are required

**Response:** `201 Created` with Location header

```json
{
  "id": "9c7e4e8a-1234-5678-9abc-def012345678",
  "name": "Charlie Davis",
  "email": "charlie@example.com"
}
```

**Example:**

```bash
curl -X POST "http://localhost:5181/api/customers" \
  -H "Content-Type: application/json" \
  -d '{"name":"Charlie Davis","email":"charlie@example.com"}'
```

---

### PUT /api/customers/{id}

Updates an existing customer.

**Path Parameters:**
- `id` (guid, required) — Customer identifier

**Request Body:**

```json
{
  "name": "Alice Johnson Updated",
  "email": "alice.updated@example.com"
}
```

**Response:** `204 No Content` on success, `404 Not Found` if customer doesn't exist

**Example:**

```bash
curl -X PUT "http://localhost:5181/api/customers/3fa85f64-5717-4562-b3fc-2c963f66afa6" \
  -H "Content-Type: application/json" \
  -d '{"name":"Alice Johnson Updated","email":"alice.updated@example.com"}'
```

---

### DELETE /api/customers/{id}

Deletes a customer by ID.

**Path Parameters:**
- `id` (guid, required) — Customer identifier

**Response:** `204 No Content`

**Example:**

```bash
curl -X DELETE "http://localhost:5181/api/customers/3fa85f64-5717-4562-b3fc-2c963f66afa6"
```

---

## Products API

### GET /api/products

Returns all products in the catalog.

**Response:** `200 OK`

```json
[
  {
    "id": "1a2b3c4d-5e6f-7890-abcd-ef1234567890",
    "name": "Widget",
    "price": 9.99,
    "stock": 100
  },
  {
    "id": "2b3c4d5e-6f78-90ab-cdef-123456789012",
    "name": "Gadget",
    "price": 19.99,
    "stock": 50
  }
]
```

---

### GET /api/products/{id}

Gets a single product by ID.

**Path Parameters:**
- `id` (guid, required) — Product identifier

**Response:** `200 OK` or `404 Not Found`

```json
{
  "id": "1a2b3c4d-5e6f-7890-abcd-ef1234567890",
  "name": "Widget",
  "price": 9.99,
  "stock": 100
}
```

---

### POST /api/products

Creates a new product.

**Request Body:**

```json
{
  "name": "Super Gadget",
  "price": 29.99,
  "stock": 75
}
```

**Notes:**
- The `id` field is auto-generated by the server
- `name`, `price`, and `stock` are required
- `price` is a decimal value
- `stock` is an integer representing available quantity

**Response:** `201 Created`

```json
{
  "id": "3c4d5e6f-7890-abcd-ef12-34567890abcd",
  "name": "Super Gadget",
  "price": 29.99,
  "stock": 75
}
```

---

### PUT /api/products/{id}

Updates an existing product.

**Path Parameters:**
- `id` (guid, required) — Product identifier

**Request Body:**

```json
{
  "name": "Widget Updated",
  "price": 12.99,
  "stock": 120
}
```

**Response:** `204 No Content` on success, `404 Not Found` if product doesn't exist

---

### DELETE /api/products/{id}

Deletes a product by ID.

**Path Parameters:**
- `id` (guid, required) — Product identifier

**Response:** `204 No Content`

---

## Orders API

### GET /api/orders

Returns all orders with their items.

**Response:** `200 OK`

```json
[
  {
    "id": "5d6e7f89-0abc-def1-2345-67890abcdef1",
    "customerId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "customer": {
      "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
      "name": "Alice Johnson",
      "email": "alice@example.com"
    },
    "createdAt": "2024-01-15T10:30:00Z",
    "status": 2,
    "items": [
      {
        "id": "6e7f8901-bcde-f123-4567-890abcdef123",
        "orderId": "5d6e7f89-0abc-def1-2345-67890abcdef1",
        "productId": "1a2b3c4d-5e6f-7890-abcd-ef1234567890",
        "product": {
          "id": "1a2b3c4d-5e6f-7890-abcd-ef1234567890",
          "name": "Widget",
          "price": 9.99,
          "stock": 100
        },
        "quantity": 2,
        "unitPrice": 9.99
      }
    ]
  }
]
```

---

### GET /api/orders/{id}

Gets a single order by ID with all related items.

**Path Parameters:**
- `id` (guid, required) — Order identifier

**Response:** `200 OK` or `404 Not Found`

```json
{
  "id": "5d6e7f89-0abc-def1-2345-67890abcdef1",
  "customerId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "customer": null,
  "createdAt": "2024-01-15T10:30:00Z",
  "status": 2,
  "items": [
    {
      "id": "6e7f8901-bcde-f123-4567-890abcdef123",
      "orderId": "5d6e7f89-0abc-def1-2345-67890abcdef1",
      "productId": "1a2b3c4d-5e6f-7890-abcd-ef1234567890",
      "product": null,
      "quantity": 2,
      "unitPrice": 9.99
    }
  ]
}
```

---

### GET /api/orders/paged

Returns a paginated list of orders.

**Query Parameters:**
- `pageNumber` (int, optional, default=1) — 1-based page number
- `pageSize` (int, optional, default=10) — Number of items per page

**Example:** `/api/orders/paged?pageNumber=1&pageSize=20`

**Response:** `200 OK`

Returns orders in the same format as `GET /api/orders`, but paginated.

---

### GET /api/orders/customer/{customerId}

Gets all orders for a specific customer.

**Path Parameters:**
- `customerId` (guid, required) — Customer identifier

**Response:** `200 OK`

```json
[
  {
    "id": "5d6e7f89-0abc-def1-2345-67890abcdef1",
    "customerId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "createdAt": "2024-01-15T10:30:00Z",
    "status": 2,
    "items": [...]
  }
]
```

---

### GET /api/orders/daterange

Gets orders within a specified date range with pagination.

**Query Parameters:**
- `startDate` (datetime, required) — Inclusive start date (ISO-8601 format)
- `endDate` (datetime, required) — Inclusive end date (ISO-8601 format)
- `pageNumber` (int, optional, default=1) — 1-based page number
- `pageSize` (int, optional, default=10) — Number of items per page

**Example:**

```
/api/orders/daterange?startDate=2024-01-01&endDate=2024-12-31&pageNumber=1&pageSize=10
```

**Response:** `200 OK`

Returns orders created between `startDate` and `endDate`, paginated.

---

### POST /api/orders

Creates a new order.

**Request Body:**

```json
{
  "customerId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "items": [
    {
      "productId": "1a2b3c4d-5e6f-7890-abcd-ef1234567890",
      "quantity": 2
    },
    {
      "productId": "2b3c4d5e-6f78-90ab-cdef-123456789012",
      "quantity": 1
    }
  ]
}
```

**Notes:**
- Server auto-generates: `id`, `createdAt`, `status` (set to `Pending`)
- Each order item gets auto-generated `id` and `orderId`
- `unitPrice` is set by the background worker during processing
- Initial status is always `Pending` (0)

**Response:** `201 Created`

```json
{
  "id": "7f890abc-def1-2345-6789-0abcdef12345",
  "customerId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "customer": null,
  "createdAt": "2024-01-15T14:22:00Z",
  "status": 0,
  "items": [
    {
      "id": "890abcde-f123-4567-890a-bcdef1234567",
      "orderId": "7f890abc-def1-2345-6789-0abcdef12345",
      "productId": "1a2b3c4d-5e6f-7890-abcd-ef1234567890",
      "product": null,
      "quantity": 2,
      "unitPrice": 0
    }
  ]
}
```

**Example:**

```bash
curl -X POST "http://localhost:5181/api/orders" \
  -H "Content-Type: application/json" \
  -d '{
    "customerId": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
    "items": [
      {"productId": "1a2b3c4d-5e6f-7890-abcd-ef1234567890", "quantity": 2}
    ]
  }'
```

---

### POST /api/orders/reprocess-pending

Manually triggers reprocessing of all pending orders.

**Request Body:** None

**Response:** `200 OK`

```json
{
  "reprocessedCount": 5
}
```

**Notes:**
- Changes order status from `Pending` (0) to `Processing` (1)
- Orders are then picked up by the background worker
- Use with caution in production environments

**Example:**

```bash
curl -X POST "http://localhost:5181/api/orders/reprocess-pending"
```

---

## Order Status Values

The `status` field in orders uses the following integer enum values:

```csharp
public enum OrderStatus
{
    Pending = 0,      // Order created, awaiting processing
    Processing = 1,   // Picked up by worker, being processed
    Completed = 2,    // Successfully processed, stock deducted
    Cancelled = 3     // Cancelled due to insufficient stock
}
```

**Status Flow:**

```
Pending (0) → Processing (1) → Completed (2)
                             ↘ Cancelled (3)
```

1. **Pending:** Order created via `POST /api/orders`
2. **Processing:** Order marked for processing (either by worker or manual trigger)
3. **Completed:** All items processed successfully, product stock deducted, unit prices set
4. **Cancelled:** Insufficient stock for one or more items

---

## Error Responses

### 400 Bad Request

Returned when request validation fails.

```json
{
  "type": "https://tools.ietf.org/html/rfc7231#section-6.5.1",
  "title": "One or more validation errors occurred.",
  "status": 400,
  "errors": {
    "Name": ["The Name field is required."]
  }
}
```

### 404 Not Found

Returned when a resource with the specified ID doesn't exist.

```json
{
  "type": "https://tools.ietf.org/html/rfc7231#section-6.5.4",
  "title": "Not Found",
  "status": 404
}
```

### 500 Internal Server Error

Returned when an unexpected server error occurs.

```json
{
  "type": "https://tools.ietf.org/html/rfc7231#section-6.6.1",
  "title": "An error occurred while processing your request.",
  "status": 500
}
```

---

## Testing the API

### Using curl

```bash
# Get all products
curl http://localhost:5181/api/products

# Create a customer
curl -X POST http://localhost:5181/api/customers \
  -H "Content-Type: application/json" \
  -d '{"name":"Test User","email":"test@example.com"}'

# Create an order
curl -X POST http://localhost:5181/api/orders \
  -H "Content-Type: application/json" \
  -d '{
    "customerId": "YOUR-CUSTOMER-ID",
    "items": [{"productId": "YOUR-PRODUCT-ID", "quantity": 1}]
  }'
```

### Using Swagger UI

1. Start the API: `dotnet run --project Api`
2. Navigate to: `http://localhost:5181/swagger`
3. Use the interactive UI to test endpoints

### Using Api.http

The project includes `Api/Api.http` with example requests for use with REST Client extensions in VS Code or Visual Studio.

---

## Related Documentation

- See [WORKSPACE.md](WORKSPACE.md) for local setup and development workflow
- See [ARCHITECTURE.md](ARCHITECTURE.md) for system design and order processing flow
- See [DATABASE.md](DATABASE.md) for database schema and entity relationships
